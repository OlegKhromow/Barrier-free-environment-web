<div class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[501] flex items-start justify-center pt-20"
     role="dialog" aria-modal="true" (click)="closeDialog($event)">

  <div
    class="bg-white w-full max-w-xl h-[80vh] flex flex-col rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">

    <!-- Overlay для блокування -->
    @if (isLoading) {
      <div class="absolute inset-0 bg-white/70 z-10 flex items-center justify-center backdrop-blur-sm">
        <div class="text-center">
          <div
            class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-deep-dark-blue border-t-transparent mb-2"></div>
          <p class="text-gray-700 font-medium">Перевірка даних...</p>
        </div>
      </div>
    }

    <div class="p-6 flex-1 overflow-y-auto overflow-x-hidden [scrollbar-gutter:stable]">
      <h2 class="text-3xl font-bold mb-6 text-center text-deep-dark-blue">
        {{ mode === 'create' ? 'Створення локації' : 'Оновлення даних локації' }}
      </h2>

      <form [formGroup]="form" class="flex flex-col gap-5">

        <input formControlName="name" placeholder="Назва*"
               class="rounded-xl px-4 py-2.5 w-full bg-gray-50 shadow-inner
              border border-gray-300 text-deep-dark-blue focus:outline-none
              focus:shadow-md focus:ring-2 focus:ring-deep-dark-blue/60
              transition"/>

        <input formControlName="address" placeholder="Адреса*"
               class="rounded-xl px-4 py-2.5 w-full bg-gray-50 shadow-inner
              border border-gray-300 text-deep-dark-blue focus:outline-none
              focus:shadow-md focus:ring-2 focus:ring-deep-dark-blue/60
              transition"/>

        <textarea formControlName="description" placeholder="Опис"
                  class="rounded-xl px-4 py-2.5 w-full min-h-[100px] bg-gray-50 shadow-inner
                 border border-gray-300 text-deep-dark-blue focus:outline-none
                 focus:shadow-md focus:ring-2 focus:ring-deep-dark-blue/60
                 transition"></textarea>

        <div *ngIf="mode === 'create'">
          <label class="font-medium text-deep-dark-blue">Тип локації</label>
          <select formControlName="type"
                  class="rounded-xl px-4 py-2.5 w-full bg-gray-50 shadow-inner
                 border border-gray-300 text-deep-dark-blue focus:outline-none
                 focus:ring-2 focus:ring-deep-dark-blue/60">
            <option value="" disabled>Оберіть тип*</option>
            @for (t of (locationTypes$ | async); track t.id) {
              <option [value]="t.id">{{ t.name }}</option>
            }
          </select>
        </div>

        <div formGroupName="contacts" class="grid gap-3">
          <div>
            <label class="text-sm font-medium text-deep-dark-blue">Телефон</label>
            <input formControlName="phone" type="text" mask="+00 (000) 000-00-00" placeholder="+00 (000) 000-00-00"
                   class="rounded-xl px-4 py-2.5 w-full bg-gray-50 shadow-inner
                  border border-gray-300 text-deep-dark-blue focus:outline-none
                  focus:ring-2 focus:ring-deep-dark-blue/60"/>
          </div>

          <div>
            <label class="text-sm font-medium text-deep-dark-blue">Email</label>
            <input formControlName="email" type="email" placeholder="yourmail@mail.com"
                   class="rounded-xl px-4 py-2.5 w-full bg-gray-50 shadow-inner
                  border border-gray-300 text-deep-dark-blue focus:outline-none
                  focus:ring-2 focus:ring-deep-dark-blue/60"/>
          </div>

          <div>
            <label class="text-sm font-medium text-deep-dark-blue">Веб-сайт</label>
            <input formControlName="website" type="text"
                   class="rounded-xl px-4 py-2.5 w-full bg-gray-50 shadow-inner
                  border border-gray-300 text-deep-dark-blue focus:outline-none
                  focus:ring-2 focus:ring-deep-dark-blue/60"/>
          </div>
        </div>

        <div [formGroup]="workingHoursForm" class="grid gap-4 mt-4 p-4 border rounded-lg bg-gray-50">

          <!-- Шапка для швидкого введення часу -->
          <div [formGroup]="quickTimeForm" class="flex flex-col gap-1 mb-3">
            <div class="flex items-center justify-evenly gap-2">
              <input type="time" formControlName="open"
                     class="border border-gray-300 rounded-lg px-2 py-1 shadow-sm"/>
              <input type="time" formControlName="close"
                     class="border border-gray-300 rounded-lg px-2 py-1 shadow-sm"/>
              <button type="button"
                      (click)="applyQuickTime()"
                      [disabled]="isQuickTimeInvalid()"
                      class="ml-2 px-3 py-1 bg-deep-dark-blue text-white rounded-lg
                     hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition">
                Застосувати до обраних днів
              </button>
            </div>

            <!-- Повідомлення про помилку -->
            @if (isQuickTimeInvalid()) {
              <div class="text-yellow-600 text-sm mt-1">
                {{
                  quickTimeForm.errors?.['incomplete']
                    ? 'Необхідно заповнити обидва поля часу'
                    : 'Час закриття повинен бути більшим за час відкриття'
                }}
              </div>
            }

          </div>

          <!-- Робочі дні -->
          @for (day of days; track day) {
            <div [formGroupName]="day" class="grid grid-cols-[auto_1fr_1fr_1fr] items-center gap-2">

              <!-- Використовуємо Reactive FormControl для чекбокса -->
              <input type="checkbox" [formControl]="getSelectedDayControl(day)" class="w-4 h-4"/>

              <label class="pr-2 font-medium text-gray-700">{{ day | titlecase }}:</label>
              <input type="time" formControlName="open" class="border border-gray-300 rounded-lg px-2 py-1 shadow-sm"/>
              <input type="time" formControlName="close" class="border border-gray-300 rounded-lg px-2 py-1 shadow-sm"/>
            </div>
          }

          <!-- Повідомлення про помилки для днів -->
          @if (form.get('workingHours')?.errors?.['workingHoursIncomplete']) {
            <div class="text-red-600 text-sm mt-1">
              Якщо заповнено час відкриття — потрібно вказати час закриття (і навпаки).
            </div>
          }
        </div>

        <div class="border-t pt-4">
          <!-- Кнопка/зона завантаження -->
          <div
            class="flex flex-col items-center justify-center w-full border-2 border-dashed border-gray-300 rounded-lg
           bg-gray-50 hover:bg-gray-100 transition duration-200 shadow-sm hover:shadow-md text-gray-600
           text-center p-4 relative"
            [ngClass]="{'bg-blue-50 border-blue-400': isDragOver}"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave()"
            (drop)="onDrop($event)"
          >
            <label for="file-upload" class="cursor-pointer w-full h-full flex flex-col items-center justify-center">
              <span class="mb-1 font-medium">Натисніть або перетягніть файли зображень сюди</span>
              <span class="text-xs text-gray-400">(підтримуються лише зображення, max 10 файлів)</span>
            </label>

            <!-- Превʼю зображень -->

            @if (selectedImages.length > 0) {
              <div class="mt-3 grid grid-cols-3 gap-3">
                @for (img of selectedImages; track i; let i = $index) {
                  <div class="relative group">
                    <img [src]="img?.preview" alt="preview"
                         class="rounded-lg shadow-md border h-28 w-full object-cover transition-transform duration-200 group-hover:scale-105"/>

                    <!-- Кнопка видалення -->
                    <button
                      type="button"
                      (click)="removeImage(img?.id)"
                      class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center
               text-xl font-bold opacity-80 hover:opacity-100 hover:scale-110 transition">
                      &times;
                    </button>

                    <p class="text-xs text-center mt-1 truncate text-gray-700">{{ img?.file?.name }}</p>
                  </div>
                }
              </div>
            }
            <input id="file-upload" type="file" (change)="onImageSelect($event)" multiple accept="image/*"
                   class="hidden"/>
          </div>
        </div>


      </form>
    </div>

    <div class="border-t p-4 flex justify-end gap-3 bg-white sticky bottom-0">
      <button type="button" (click)="cancel()" [disabled]="isLoading"
              class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
        Скасувати
      </button>

      <button type="button" (click)="save()" [disabled]="isFormInvalid() || isLoading"
              class="px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-lg">
        @if (isLoading) {
          <span
            class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>
        }
        @if (isLoading) {
          Обробка...
        } @else {
          {{ mode === 'create' ? 'Зберегти' : 'Надіслати на перевірку' }}
        }
      </button>
    </div>

  </div>
</div>
