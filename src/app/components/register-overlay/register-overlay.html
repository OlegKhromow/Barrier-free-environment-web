<div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[501]" (click)="close($event)">
  <div class="bg-white rounded-3xl shadow-xl w-96 p-8 z-50 border border-gray-200 relative">

    <h2 class="text-2xl font-bold text-center mb-6 text-deep-dark-blue">
      Реєстрація
    </h2>

    @if (isLoading) {
      <div class="absolute inset-0 bg-white/70 flex items-center justify-center rounded-3xl z-50">
        <div class="h-10 w-10 border-4 border-deep-dark-blue border-t-transparent rounded-full animate-spin"></div>
      </div>
    }
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Якщо ще НЕ підтверджуємо email -->
      @if (!emailSent) {
        <div class="space-y-3">

          <div>
            <label class="text-sm font-medium text-deep-dark-blue">Придумайте логін</label>
            <input
              type="text"
              formControlName="username"
              placeholder="username"
              class="w-full px-4 py-3 rounded-2xl border border-gray-300 bg-gray-100
                   focus:ring-2 focus:ring-deep-dark-blue outline-none">
            @if (form.get('username')?.touched && form.get('username')?.errors?.['taken']) {
              <div class="text-red-600 text-sm">Такий користувач уже існує</div>
            }
          </div>

          <div>
            <label class="text-sm font-medium text-deep-dark-blue">Email</label>
            <input
              type="email"
              formControlName="email"
              placeholder="yourmail@mail.com"
              class="w-full px-4 py-3 rounded-2xl border border-gray-300 bg-gray-100
                   focus:ring-2 focus:ring-deep-dark-blue outline-none"
              required>
          </div>
          @if (form.get('email')?.errors?.['email']) {
            <div class="text-red-600 text-sm">
              Невірний формат email
            </div>
          }

          <div class="relative">
            <label class="text-sm font-medium text-deep-dark-blue">Придумайте пароль</label>
            <input
              [type]="showPassword ? 'text' : 'password'"
              formControlName="password"
              placeholder="(мінімум 8 символів)"
              class="w-full px-4 py-3 rounded-2xl border border-gray-300 bg-gray-100
                     focus:ring-2 focus:ring-deep-dark-blue outline-none">

            <label class="flex items-center gap-2 my-2 text-sm cursor-pointer">
              <input type="checkbox" formControlName="showPassword">
              Показати пароль
            </label>

            <input
              [type]="showPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="Повторіть пароль"
              class="w-full px-4 py-3 rounded-2xl border border-gray-300 bg-gray-100
                   focus:ring-2 focus:ring-deep-dark-blue outline-none">
          </div>

          @if (passwordMismatch) {
            <p class="text-red-600 text-sm">Паролі не співпадають</p>
          }
          @if (form.get('password')?.touched && form.get('password')?.errors?.['minlength']) {
            <p class="text-red-600 text-sm">Паролі має бути мінімум 8 символів</p>
          }
        </div>

        <div class="flex justify-between mt-6">
          <button type="button"
                  class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 transition"
                  (click)="cancel()">
            Скасувати
          </button>

          <button type="button"
                  class="px-4 py-2 rounded-xl bg-deep-dark-blue text-white hover:bg-[#15263A]
               transition disabled:opacity-50 disabled:cursor-not-allowed"
                  (click)="sendVerificationEmail()"
                  [disabled]="isLoading ||
                   form.get('username')?.invalid || form.get('username')?.pending ||
                   form.get('email')?.invalid ||
                   form.get('password')?.invalid ||
                   form.get('confirmPassword')?.invalid ||
                   passwordMismatch">
            Підтвердити пошту
          </button>

        </div>
      } @else {
        <p class="text-center mb-4">
          Ми надіслали код підтвердження на <strong>{{ form.value.email }}</strong>
        </p>

        <input
          type="text"
          formControlName="verificationCode"
          placeholder="Код з листа"
          class="w-full px-4 py-3 rounded-2xl border border-gray-300 bg-gray-100
                 focus:ring-2 focus:ring-deep-dark-blue outline-none">
        @if (form.get('verificationCode')?.touched && form.get('verificationCode')?.errors) {
          <p class="text-red-600 text-sm">Код не співпадає</p>
        }

        <button type="submit"
                class="w-full mt-5 bg-deep-dark-blue text-white py-3 rounded-2xl
                       hover:bg-[#15263A] transition">
          Створити акаунт
        </button>

        <button type="button"
                class="w-full mt-3 py-2 border border-gray-300 rounded-xl hover:bg-gray-100 transition"
                (click)="cancelVerification()">
          Назад
        </button>

      }

    </form>
  </div>
</div>
